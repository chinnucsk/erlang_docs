<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html xmlns:fn="http://www.w3.org/2005/02/xpath-functions">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<link rel="stylesheet" href="../otp_doc.css" type="text/css">
<title>Erlang -- Gen_Event Behaviour</title>
</head>
<body bgcolor="white" text="#000000" link="#0000ff" vlink="#ff00ff" alink="#ff0000"><div id="container">
<script id="js" type="text/javascript" language="JavaScript" src="../js/flipmenu/flipmenu.js"></script><script id="js2" type="text/javascript" src="../js/erlresolvelinks.js"></script><div id="leftnav"><div class="innertube">
<img alt="Erlang logo" src="../erlang-logo.png"><br><small>
<a href="users_guide.html">User's Guide</a><br>
<a href="../pdf/otp-system-documentation.pdf">PDF</a><br>
<a href="../index.html">Top</a></small><p><strong>OTP Design Principles</strong><br><strong>User's Guide</strong><br><small>Version 5.7.4</small></p>
<br>
<a href="javascript:openAllFlips()">Expand All</a><br>
<a href="javascript:closeAllFlips()">Contract All</a><p><small><strong>Chapters</strong></small></p>
<ul class="flipMenu" imagepath="../js/flipmenu">
<li title="Overview" expanded="false">Overview<ul>
<li>
<a href="des_princ.html">
              Top of chapter
            </a></li>
<li title="Supervision Trees">
<a href="des_princ.html#id2252268">Supervision Trees</a></li>
<li title="Behaviours">
<a href="des_princ.html#id2258984">Behaviours</a></li>
<li title="Applications">
<a href="des_princ.html#id2252297">Applications</a></li>
<li title="Releases">
<a href="des_princ.html#id2252171">Releases</a></li>
<li title="Release Handling">
<a href="des_princ.html#id2254710">Release Handling</a></li>
</ul>
</li>
<li title="Gen_Server Behaviour" expanded="false">Gen_Server Behaviour<ul>
<li>
<a href="gen_server_concepts.html">
              Top of chapter
            </a></li>
<li title="Client-Server Principles">
<a href="gen_server_concepts.html#id2252090">Client-Server Principles</a></li>
<li title="Example">
<a href="gen_server_concepts.html#id2252110">Example</a></li>
<li title="Starting a Gen_Server">
<a href="gen_server_concepts.html#id2258596">Starting a Gen_Server</a></li>
<li title="Synchronous Requests - Call">
<a href="gen_server_concepts.html#id2267098">Synchronous Requests - Call</a></li>
<li title="Asynchronous Requests - Cast">
<a href="gen_server_concepts.html#id2262742">Asynchronous Requests - Cast</a></li>
<li title="Stopping">
<a href="gen_server_concepts.html#id2264124">Stopping</a></li>
<li title="Handling Other Messages">
<a href="gen_server_concepts.html#id2264230">Handling Other Messages</a></li>
</ul>
</li>
<li title="Gen_Fsm Behaviour" expanded="false">Gen_Fsm Behaviour<ul>
<li>
<a href="fsm.html">
              Top of chapter
            </a></li>
<li title="Finite State Machines">
<a href="fsm.html#id2251340">Finite State Machines</a></li>
<li title="Example">
<a href="fsm.html#id2256726">Example</a></li>
<li title="Starting a Gen_Fsm">
<a href="fsm.html#id2261953">Starting a Gen_Fsm</a></li>
<li title="Notifying About Events">
<a href="fsm.html#id2258488">Notifying About Events</a></li>
<li title="Timeouts">
<a href="fsm.html#id2258580">Timeouts</a></li>
<li title="All State Events">
<a href="fsm.html#id2264981">All State Events</a></li>
<li title="Stopping">
<a href="fsm.html#id2265017">Stopping</a></li>
<li title="Handling Other Messages">
<a href="fsm.html#id2266792">Handling Other Messages</a></li>
</ul>
</li>
<li title="Gen_Event Behaviour" expanded="true">Gen_Event Behaviour<ul>
<li>
<a href="events.html">
              Top of chapter
            </a></li>
<li title="Event Handling Principles">
<a href="events.html#id2267995">Event Handling Principles</a></li>
<li title="Example">
<a href="events.html#id2268056">Example</a></li>
<li title="Starting an Event Manager">
<a href="events.html#id2268104">Starting an Event Manager</a></li>
<li title="Adding an Event Handler">
<a href="events.html#id2268171">Adding an Event Handler</a></li>
<li title="Notifying About Events">
<a href="events.html#id2268262">Notifying About Events</a></li>
<li title="Deleting an Event Handler">
<a href="events.html#id2268339">Deleting an Event Handler</a></li>
<li title="Stopping">
<a href="events.html#id2268420">Stopping</a></li>
</ul>
</li>
<li title="Supervisor Behaviour" expanded="false">Supervisor Behaviour<ul>
<li>
<a href="sup_princ.html">
              Top of chapter
            </a></li>
<li title="Supervision Principles">
<a href="sup_princ.html#id2268545">Supervision Principles</a></li>
<li title="Example">
<a href="sup_princ.html#id2268573">Example</a></li>
<li title="Restart Strategy">
<a href="sup_princ.html#id2268648">Restart Strategy</a></li>
<li title="Maximum Restart Frequency">
<a href="sup_princ.html#id2266142">Maximum Restart Frequency</a></li>
<li title="Child Specification">
<a href="sup_princ.html#id2266207">Child Specification</a></li>
<li title="Starting a Supervisor">
<a href="sup_princ.html#id2266525">Starting a Supervisor</a></li>
<li title="Adding a Child Process">
<a href="sup_princ.html#id2266650">Adding a Child Process</a></li>
<li title="Stopping a Child Process">
<a href="sup_princ.html#id2266699">Stopping a Child Process</a></li>
<li title="Simple-One-For-One Supervisors">
<a href="sup_princ.html#id2268750">Simple-One-For-One Supervisors</a></li>
<li title="Stopping">
<a href="sup_princ.html#id2268847">Stopping</a></li>
</ul>
</li>
<li title="Sys and Proc_Lib" expanded="false">Sys and Proc_Lib<ul>
<li>
<a href="spec_proc.html">
              Top of chapter
            </a></li>
<li title="Simple Debugging">
<a href="spec_proc.html#id2268956">Simple Debugging</a></li>
<li title="Special Processes">
<a href="spec_proc.html#id2269055">Special Processes</a></li>
<li title="User-Defined Behaviours">
<a href="spec_proc.html#id2269737">User-Defined Behaviours</a></li>
</ul>
</li>
<li title="Applications" expanded="false">Applications<ul>
<li>
<a href="applications.html">
              Top of chapter
            </a></li>
<li title="Application Concept">
<a href="applications.html#id2269898">Application Concept</a></li>
<li title="Application Callback Module">
<a href="applications.html#id2269972">Application Callback Module</a></li>
<li title="Application Resource File">
<a href="applications.html#id2270097">Application Resource File</a></li>
<li title="Directory Structure">
<a href="applications.html#id2270364">Directory Structure</a></li>
<li title="Application Controller">
<a href="applications.html#id2270499">Application Controller</a></li>
<li title="Loading and Unloading Applications">
<a href="applications.html#id2270536">Loading and Unloading Applications</a></li>
<li title="Starting and Stopping Applications">
<a href="applications.html#id2270605">Starting and Stopping Applications</a></li>
<li title="Configuring an Application">
<a href="applications.html#id2270704">Configuring an Application</a></li>
<li title="Application Start Types">
<a href="applications.html#id2270920">Application Start Types</a></li>
</ul>
</li>
<li title="Included Applications" expanded="false">Included Applications<ul>
<li>
<a href="included_applications.html">
              Top of chapter
            </a></li>
<li title="Definition">
<a href="included_applications.html#id2271074">Definition</a></li>
<li title="Specifying Included Applications">
<a href="included_applications.html#id2271148">Specifying Included Applications</a></li>
<li title="Synchronizing Processes During Startup">
<a href="included_applications.html#id2271177">Synchronizing Processes During Startup</a></li>
</ul>
</li>
<li title="Distributed Applications" expanded="false">Distributed Applications<ul>
<li>
<a href="distributed_applications.html">
              Top of chapter
            </a></li>
<li title="Definition">
<a href="distributed_applications.html#id2271422">Definition</a></li>
<li title="Specifying Distributed Applications">
<a href="distributed_applications.html#id2271465">Specifying Distributed Applications</a></li>
<li title="Starting and Stopping Distributed Applications">
<a href="distributed_applications.html#id2271692">Starting and Stopping Distributed Applications</a></li>
<li title="Failover">
<a href="distributed_applications.html#id2271804">Failover</a></li>
<li title="Takeover">
<a href="distributed_applications.html#id2271956">Takeover</a></li>
</ul>
</li>
<li title="Releases" expanded="false">Releases<ul>
<li>
<a href="release_structure.html">
              Top of chapter
            </a></li>
<li title="Release Concept">
<a href="release_structure.html#id2272165">Release Concept</a></li>
<li title="Release Resource File">
<a href="release_structure.html#id2272223">Release Resource File</a></li>
<li title="Generating Boot Scripts">
<a href="release_structure.html#id2272372">Generating Boot Scripts</a></li>
<li title="Creating a Release Package">
<a href="release_structure.html#id2272480">Creating a Release Package</a></li>
<li title="Directory Structure">
<a href="release_structure.html#id2272613">Directory Structure</a></li>
</ul>
</li>
<li title="Release Handling" expanded="false">Release Handling<ul>
<li>
<a href="release_handling.html">
              Top of chapter
            </a></li>
<li title="Release Handling Principles">
<a href="release_handling.html#id2272899">Release Handling Principles</a></li>
<li title="Requirements">
<a href="release_handling.html#id2273174">Requirements</a></li>
<li title="Distributed Systems">
<a href="release_handling.html#id2273276">Distributed Systems</a></li>
<li title="Release Handling Instructions">
<a href="release_handling.html#id2273306">Release Handling Instructions</a></li>
<li title="Application Upgrade File">
<a href="release_handling.html#id2273789">Application Upgrade File</a></li>
<li title="Release Upgrade File">
<a href="release_handling.html#id2273992">Release Upgrade File</a></li>
<li title="Installing a Release">
<a href="release_handling.html#id2274164">Installing a Release</a></li>
<li title="Updating Application Specifications">
<a href="release_handling.html#id2274681">Updating Application Specifications</a></li>
</ul>
</li>
<li title="Appup Cookbook" expanded="false">Appup Cookbook<ul>
<li>
<a href="appup_cookbook.html">
              Top of chapter
            </a></li>
<li title="Changing a Functional Module">
<a href="appup_cookbook.html#id2274885">Changing a Functional Module</a></li>
<li title="Changing a Residence Module">
<a href="appup_cookbook.html#id2274910">Changing a Residence Module</a></li>
<li title="Changing a Callback Module">
<a href="appup_cookbook.html#id2274952">Changing a Callback Module</a></li>
<li title="Changing Internal State">
<a href="appup_cookbook.html#id2275007">Changing Internal State</a></li>
<li title="Module Dependencies">
<a href="appup_cookbook.html#id2275158">Module Dependencies</a></li>
<li title="Changing Code For a Special Process">
<a href="appup_cookbook.html#id2275341">Changing Code For a Special Process</a></li>
<li title="Changing a Supervisor">
<a href="appup_cookbook.html#id2275527">Changing a Supervisor</a></li>
<li title="Adding or Deleting a Module">
<a href="appup_cookbook.html#id2275808">Adding or Deleting a Module</a></li>
<li title="Starting or Terminating a Process">
<a href="appup_cookbook.html#id2275834">Starting or Terminating a Process</a></li>
<li title="Adding or Removing an Application">
<a href="appup_cookbook.html#id2275854">Adding or Removing an Application</a></li>
<li title="Restarting an Application">
<a href="appup_cookbook.html#id2275887">Restarting an Application</a></li>
<li title="Changing an Application Specification">
<a href="appup_cookbook.html#id2275933">Changing an Application Specification</a></li>
<li title="Changing Application Configuration">
<a href="appup_cookbook.html#id2275959">Changing Application Configuration</a></li>
<li title="Changing Included Applications">
<a href="appup_cookbook.html#id2275995">Changing Included Applications</a></li>
<li title="Changing Non-Erlang Code">
<a href="appup_cookbook.html#id2276275">Changing Non-Erlang Code</a></li>
<li title="Emulator Restart">
<a href="appup_cookbook.html#id2276372">Emulator Restart</a></li>
</ul>
</li>
</ul>
</div></div>
<div id="content">
<div class="innertube">
<h1>4 Gen_Event Behaviour</h1>
  
  <a name="gen_event"></a>
  <p>This chapter should be read in conjunction with
    <span class="code">gen_event(3)</span>, where all interface functions and callback
    functions are described in detail.</p>
  <h3><a name="id2267995">4.1 
        Event Handling Principles</a></h3>
    
    <p>In OTP, an <strong>event manager</strong> is a named object to which
      events can be sent. An <strong>event</strong> could be, for example,
      an error, an alarm or some information that should be logged.</p>
    <p>In the event manager, zero, one or several <strong>event handlers</strong> are installed. When the event manager is notified
      about an event, the event will be processed by all the installed
      event handlers. For example, an event manager for handling errors
      can by default have a handler installed which writes error
      messages to the terminal. If the error messages during a certain
      period should be saved to a file as well, the user adds another
      event handler which does this. When logging to file is no longer
      necessary, this event handler is deleted.</p>
    <p>An event manager is implemented as a process and each event
      handler is implemented as a callback module.</p>
    <p>The event manager essentially maintains a list of
      <span class="code">{Module, State}</span> pairs, where each <span class="code">Module</span> is an
      event handler, and <span class="code">State</span> the internal state of that event
      handler.</p>
  
  <h3><a name="id2268056">4.2 
        Example</a></h3>
    
    <p>The callback module for the event handler writing error messages
      to the terminal could look like:</p>
    <div class="example"><pre>
-module(terminal_logger).
-behaviour(gen_event).
-export([init/1, handle_event/2, terminate/2]).
init(_Args) -&gt;
    {ok, []}.
handle_event(ErrorMsg, State) -&gt;
    io:format("***Error*** ~p~n", [ErrorMsg]),
    {ok, State}.
terminate(_Args, _State) -&gt;
    ok.</pre></div>
    <p>The callback module for the event handler writing error messages
      to a file could look like:</p>
    <div class="example"><pre>
-module(file_logger).
-behaviour(gen_event).
-export([init/1, handle_event/2, terminate/2]).
init(File) -&gt;
    {ok, Fd} = file:open(File, read),
    {ok, Fd}.
handle_event(ErrorMsg, Fd) -&gt;
    io:format(Fd, "***Error*** ~p~n", [ErrorMsg]),
    {ok, Fd}.
terminate(_Args, Fd) -&gt;
    file:close(Fd).</pre></div>
    <p>The code is explained in the next sections.</p>
  
  <h3><a name="id2268104">4.3 
        Starting an Event Manager</a></h3>
    <a name="mgr"></a>
    
    <p>To start an event manager for handling errors, as described in
      the example above, call the following function:</p>
    <div class="example"><pre>
gen_event:start_link({local, error_man})</pre></div>
    <p>This function spawns and links to a new process, an event
      manager.</p>
    <p>The argument, <span class="code">{local, error_man}</span> specifies the name. In
      this case, the event manager will be locally registered as
      <span class="code">error_man</span>.</p>
    <p>If the name is omitted, the event manager is not registered.
      Instead its pid must be used. The name could also be given
      as <span class="code">{global, Name}</span>, in which case the event manager is
      registered using <span class="code">global:register_name/2</span>.</p>
    <p><span class="code">gen_event:start_link</span> must be used if the event manager is
      part of a supervision tree, i.e. is started by a supervisor.
      There is another function <span class="code">gen_event:start</span> to start a
      stand-alone event manager, i.e. an event manager which is not
      part of a supervision tree.</p>
  
  <h3><a name="id2268171">4.4 
        Adding an Event Handler</a></h3>
    
    <p>Here is an example using the shell on how to start an event
      manager and add an event handler to it:</p>
    <div class="example"><pre>
1&gt; <span class="bold_code">gen_event:start({local, error_man}).</span>
{ok,&lt;0.31.0&gt;}
2&gt; <span class="bold_code">gen_event:add_handler(error_man, terminal_logger, []).</span>
ok</pre></div>
    <p>This function sends a message to the event manager registered as
      <span class="code">error_man</span>, telling it to add the event handler
      <span class="code">terminal_logger</span>. The event manager will call the callback
      function <span class="code">terminal_logger:init([])</span>, where the argument []
      is the third argument to <span class="code">add_handler</span>. <span class="code">init</span> is
      expected to return <span class="code">{ok, State}</span>, where <span class="code">State</span> is
      the internal state of the event handler.</p>
    <div class="example"><pre>
init(_Args) -&gt;
    {ok, []}.</pre></div>
    <p>Here, <span class="code">init</span> does not need any input data and ignores its
      argument. Also, for <span class="code">terminal_logger</span> the internal state is
      not used. For <span class="code">file_logger</span>, the internal state is used
      to save the open file descriptor.</p>
    <div class="example"><pre>
init(File) -&gt;
    {ok, Fd} = file:open(File, read),
    {ok, Fd}.</pre></div>
  
  <h3><a name="id2268262">4.5 
        Notifying About Events</a></h3>
    
    <div class="example"><pre>
3&gt; <span class="bold_code">gen_event:notify(error_man, no_reply).</span>
***Error*** no_reply
ok</pre></div>
    <p><span class="code">error_man</span> is the name of the event manager and
      <span class="code">no_reply</span> is the event.</p>
    <p>The event is made into a message and sent to the event manager.
      When the event is received, the event manager calls
      <span class="code">handle_event(Event, State)</span> for each installed event
      handler, in the same order as they were added. The function is
      expected to return a tuple <span class="code">{ok, State1}</span>, where
      <span class="code">State1</span> is a new value for the state of the event handler.</p>
    <p>In <span class="code">terminal_logger</span>:</p>
    <div class="example"><pre>
handle_event(ErrorMsg, State) -&gt;
    io:format("***Error*** ~p~n", [ErrorMsg]),
    {ok, State}.</pre></div>
    <p>In <span class="code">file_logger</span>:</p>
    <div class="example"><pre>
handle_event(ErrorMsg, Fd) -&gt;
    io:format(Fd, "***Error*** ~p~n", [ErrorMsg]),
    {ok, Fd}.</pre></div>
  
  <h3><a name="id2268339">4.6 
        Deleting an Event Handler</a></h3>
    
    <div class="example"><pre>
4&gt; <span class="bold_code">gen_event:delete_handler(error_man, terminal_logger, []).</span>
ok</pre></div>
    <p>This function sends a message to the event manager registered as
      <span class="code">error_man</span>, telling it to delete the event handler
      <span class="code">terminal_logger</span>. The event manager will call the callback
      function <span class="code">terminal_logger:terminate([], State)</span>, where
      the argument [] is the third argument to <span class="code">delete_handler</span>.
      <span class="code">terminate</span> should be the opposite of <span class="code">init</span> and do any
      necessary cleaning up. Its return value is ignored.</p>
    <p>For <span class="code">terminal_logger</span>, no cleaning up is necessary:</p>
    <div class="example"><pre>
terminate(_Args, _State) -&gt;
    ok.</pre></div>
    <p>For <span class="code">file_logger</span>, the file descriptor opened in <span class="code">init</span>
      needs to be closed:</p>
    <div class="example"><pre>
terminate(_Args, Fd) -&gt;
    file:close(Fd).</pre></div>
  
  <h3><a name="id2268420">4.7 
        Stopping</a></h3>
    
    <p>When an event manager is stopped, it will give each of
      the installed event handlers the chance to clean up by calling
      <span class="code">terminate/2</span>, the same way as when deleting a handler.</p>
    <h4>In a Supervision Tree</h4>
      
      <p>If the event manager is part of a supervision tree, no stop
        function is needed. The event manager will automatically be
        terminated by its supervisor. Exactly how this is done is
        defined by a <span class="bold_code">
<a href="sup_princ.html#shutdown">shutdown strategy</a></span> set in the supervisor.</p>
    
    <h4>Stand-Alone Event Managers</h4>
      
      <p>An event manager can also be stopped by calling:</p>
      <div class="example"><pre>
&gt; <span class="bold_code">gen_event:stop(error_man).</span>
ok</pre></div>
    
  
</div>
<div class="footer">
<hr>
<p>Copyright © 1997-2009 Ericsson AB. All Rights Reserved.</p>
</div>
</div>
</div>
<script src="http://www.google-analytics.com/urchin.js" type="text/javascript">
</script>
<script type="text/javascript">
_uacct = "UA-3045895-1";
urchinTracker();
</script> 
</body>
</html>
